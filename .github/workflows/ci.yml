name: CI

permissions:
  contents: read
  pull-requests: read

on:
  push:
  pull_request:
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: pip install ruff==0.1.6 black==23.9.1 pytest requests
      - name: Lint
        run: |
          ruff check backend/ tests/ *.py
          # For PRs, only check changed Python files
          # For pushes to main, check all files
          # For pushes to feature branches, check diff from main
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }} --depth=1
            CHANGED_PY=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' | tr '\n' ' ')
            if [ -n "$CHANGED_PY" ]; then
              echo "Checking formatting for changed files: $CHANGED_PY"
              black --check $CHANGED_PY
            else
              echo "No Python files changed in PR"
            fi
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "Push to main - checking all files"
            black --check .
          else
            echo "Push to feature branch - checking diff from main"
            git fetch origin main --depth=1
            CHANGED_PY=$(git diff --name-only origin/main...HEAD -- '*.py' | tr '\n' ' ')
            if [ -n "$CHANGED_PY" ]; then
              echo "Checking formatting for changed files: $CHANGED_PY"
              black --check $CHANGED_PY
            else
              echo "No Python files changed from main"
            fi
          fi

  typescript-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - name: TypeScript tests
        run: npm test
      - name: Validate model registries
        run: |
          npm run validate:registry
          APP_ENV=staging MODEL_REGISTRY_PATH=shared/model-registry-staging.json npm run validate:registry
          APP_ENV=prod MODEL_REGISTRY_PATH=shared/model-registry-prod.json npm run validate:registry

  unit-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      SECRET_KEY: test-secret-for-ci
      JWT_SECRET: test-jwt-secret-for-ci
      JWT_ENABLED: "false"
      DATABASE_URL: sqlite:///./test.db
      APP_ENV: ci
      ENABLE_AUDIT_LOGGING: false
      OAUTH_DEVICE_USE_IN_MEMORY_STORE: true
      CI_NON_BLOCKING_DB_CHECKS: true
      REQUIRE_REDIS_FOR_LOCK_TESTS: "false"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: pip install -r requirements-test.txt
      - run: pip install pytest requests
      - name: Unit tests
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          alembic upgrade head
          pytest -q backend/tests
          pytest -q tests -m "not integration"

  distributed-lock-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=20
    env:
      SECRET_KEY: test-secret-for-ci
      JWT_SECRET: test-jwt-secret-for-ci
      JWT_ENABLED: "false"
      DATABASE_URL: sqlite:///./test.db
      APP_ENV: ci
      ENABLE_AUDIT_LOGGING: false
      OAUTH_DEVICE_USE_IN_MEMORY_STORE: true
      CI_NON_BLOCKING_DB_CHECKS: true
      REDIS_URL: redis://127.0.0.1:6379/0
      NAVI_TEST_REDIS_URL: redis://127.0.0.1:6379/15
      CI: "true"
      REQUIRE_REDIS_FOR_LOCK_TESTS: "true"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: pip install pytest requests
      - name: Wait for Redis
        run: |
          python - <<'PY'
          import os
          import sys
          import time
          import redis

          urls = [
              os.getenv("NAVI_TEST_REDIS_URL"),
              os.getenv("REDIS_URL"),
              "redis://127.0.0.1:6379/15",
              "redis://localhost:6379/15",
              "redis://redis:6379/15",
          ]
          candidates = []
          seen = set()
          for url in urls:
              v = (url or "").strip()
              if v and v not in seen:
                  seen.add(v)
                  candidates.append(v)

          for attempt in range(1, 31):
              for url in candidates:
                  try:
                      client = redis.from_url(url, decode_responses=True)
                      client.ping()
                      print(f"Redis is ready at {url}")
                      sys.exit(0)
                  except Exception:
                      pass
              time.sleep(1)

          print(f"Redis did not become ready. candidates={candidates}")
          sys.exit(1)
          PY
      - name: Distributed lock tests
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          pytest -q backend/tests/test_job_manager_locking_redis.py
          pytest -q backend/tests/test_job_uvicorn_two_workers.py

  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mentor
          POSTGRES_PASSWORD: mentor
          POSTGRES_DB: mentor
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U mentor"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      APP_ENV: ci
      DATABASE_URL: postgresql://mentor:mentor@localhost:5432/mentor
      REDIS_URL: redis://localhost:6379/0
      JWT_SECRET: test-jwt-secret-for-ci
      ENABLE_AUDIT_LOGGING: false
      OAUTH_DEVICE_USE_IN_MEMORY_STORE: true
      RUN_INTEGRATION_TESTS: "1"
      NAVI_TEST_URL: http://127.0.0.1:8000
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: pip install pytest requests
      - name: Integration tests (shard ${{ matrix.shard }})
        env:
          SHARD: ${{ matrix.shard }}
          SHARDS: 3
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          alembic upgrade head

          API_HOST=127.0.0.1 API_PORT=8000 python -m backend.api.main > /tmp/main.log 2>&1 &
          MAIN_PID=$!

          for i in {1..10}; do
            sleep 1
            if curl -f http://127.0.0.1:8000/health > /dev/null 2>&1; then
              echo "API started successfully"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "API failed to start"
              cat /tmp/main.log || echo "No main logs"
              kill $MAIN_PID 2>/dev/null || true
              exit 1
            fi
          done

          python - <<'PY'
          import glob
          import os
          import sys
          import re
          shard = int(os.environ.get("SHARD", "1"))
          total = int(os.environ.get("SHARDS", "3"))

          # Compile regex once outside the loop for efficiency
          integration_pattern = re.compile(r'pytest\.mark\.integration')

          # Only include files that actually have integration-marked tests
          all_files = sorted(glob.glob("tests/test_*.py"))
          integration_files = []
          for f in all_files:
              try:
                  with open(f, encoding="utf-8") as fh:
                      content = fh.read()
                  # Check for @pytest.mark.integration or pytestmark = pytest.mark.integration
                  if integration_pattern.search(content):
                      integration_files.append(f)
              except (OSError, UnicodeDecodeError) as e:
                  print(f"Warning: could not read {f}: {e}", file=sys.stderr)

          # Shard only the integration test files
          selected = [f for i, f in enumerate(integration_files) if i % total == (shard - 1)]
          if not selected:
            print("No integration test files selected for shard", shard)
            sys.exit(0)
          print("Selected integration files:", selected)
          with open("/tmp/integration_files.txt", "w") as f:
            f.write(" ".join(selected))
          PY

          # Check if any files were selected
          if [ ! -s /tmp/integration_files.txt ]; then
            echo "No integration test files for this shard - skipping"
            exit 0
          fi

          for attempt in 1 2; do
            pytest -q $(cat /tmp/integration_files.txt) -m integration && break
            exit_code=$?
            # Exit code 5 means no tests collected - treat as success for this shard
            if [ $exit_code -eq 5 ]; then
              echo "No integration tests collected for this shard - continuing"
              break
            fi
            if [ $attempt -eq 2 ]; then
              echo "Integration tests failed after retry"
              exit 1
            fi
            echo "Retrying integration tests after 5 second delay..."
            sleep 5
          done

          kill $MAIN_PID 2>/dev/null || true

  e2e-smoke:
    needs: [lint, typescript-tests, unit-tests, distributed-lock-tests, integration-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mentor
          POSTGRES_PASSWORD: mentor
          POSTGRES_DB: mentor
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U mentor"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      APP_ENV: ci
      DATABASE_URL: postgresql://mentor:mentor@localhost:5432/mentor
      REDIS_URL: redis://localhost:6379/0
      JWT_SECRET: test-jwt-secret-for-ci
      ENABLE_AUDIT_LOGGING: false
      OAUTH_DEVICE_USE_IN_MEMORY_STORE: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: pip install pytest requests
      - name: E2E smoke (single run)
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          alembic upgrade head

          API_HOST=127.0.0.1 API_PORT=8000 python -m backend.api.main > /tmp/main.log 2>&1 &
          MAIN_PID=$!

          for i in {1..10}; do
            sleep 1
            if curl -f http://127.0.0.1:8000/health > /dev/null 2>&1; then
              echo "API started successfully"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "API failed to start"
              cat /tmp/main.log || echo "No main logs"
              kill $MAIN_PID 2>/dev/null || true
              exit 1
            fi
          done

          make e2e-smoke

          kill $MAIN_PID 2>/dev/null || true
        env:
          SHARD: ${{ matrix.shard }}
          SHARDS: 3

  e2e-gate:
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    needs: [lint, typescript-tests, unit-tests, integration-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 90
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mentor
          POSTGRES_PASSWORD: mentor
          POSTGRES_DB: mentor
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U mentor"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      APP_ENV: ci
      DATABASE_URL: postgresql://mentor:mentor@localhost:5432/mentor
      REDIS_URL: redis://localhost:6379/0
      JWT_SECRET: test-jwt-secret-for-ci
      ENABLE_AUDIT_LOGGING: false
      OAUTH_DEVICE_USE_IN_MEMORY_STORE: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: pip install pytest requests
      - name: E2E gate (20 runs)
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          alembic upgrade head

          API_HOST=127.0.0.1 API_PORT=8000 python -m backend.api.main > /tmp/main.log 2>&1 &
          MAIN_PID=$!

          for i in {1..15}; do
            sleep 1
            if curl -f http://127.0.0.1:8000/health > /dev/null 2>&1; then
              echo "API started successfully"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "API failed to start"
              cat /tmp/main.log || echo "No main logs"
              kill $MAIN_PID 2>/dev/null || true
              exit 1
            fi
          done

          make e2e-gate

          kill $MAIN_PID 2>/dev/null || true
