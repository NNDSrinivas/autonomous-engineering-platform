name: CI
on:
  push:
  pull_request:
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: pip install ruff black pytest requests
      - name: Lint
        run: ruff check . && black --check .
      - name: Unit tests (health only for now)
        env:
          SECRET_KEY: test-secret-for-ci
          JWT_SECRET: test-jwt-secret-for-ci
        run: |
          API_PORT=8002 python -m backend.api.main & sleep 2
          python -m backend.api.realtime & sleep 2
          python - <<'PY'
          import requests, sys
          for port in (8002,8001):
              r = requests.get(f"http://localhost:{port}/health", timeout=2)
              assert r.status_code==200
          print("health ok")
          PY
