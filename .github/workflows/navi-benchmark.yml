name: NAVI Nightly Benchmark

on:
  schedule:
    # Nightly at 03:00 UTC
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest requests
      - name: Run NAVI benchmark
        run: |
          python3 scripts/navi_benchmark.py
      - name: Commit scorecard
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/NAVI_BENCHMARK_SCORECARD.md
          if git diff --cached --quiet; then
            echo "No scorecard changes to commit."
            exit 0
          fi
          git commit -m "chore: update NAVI benchmark scorecard"
          git push origin HEAD:${{ github.ref_name }}
      - name: Post results to GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'tmp/navi_benchmark_report.json';
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const rows = report.results.map(r =>
              `| ${r.id} | ${r.label} | ${r.success} | ${r.duration_seconds}s |`
            ).join('\\n');

            const body = [
              `## NAVI Nightly Benchmark`,
              ``,
              `**Run:** ${runUrl}`,
              ``,
              `**Summary**`,
              `- Tasks: ${report.task_count}`,
              `- Passed: ${report.summary.passed}`,
              `- Failed: ${report.summary.failed}`,
              `- Total Duration (s): ${report.summary.total_duration_seconds}`,
              ``,
              `**Results**`,
              `| Task | Label | Success | Duration |`,
              `| --- | --- | --- | --- |`,
              rows,
            ].join('\\n');

            const issueTitle = 'NAVI Nightly Benchmark Report';

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            const existing = issues.find(i => i.title === issueTitle);

            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body,
              });
              core.info(`Updated issue #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body,
              });
              core.info(`Created issue #${created.data.number}`);
            }
      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: navi-benchmark-${{ github.run_id }}
          path: |
            tmp/navi_benchmark_report.json
            docs/NAVI_BENCHMARK_SCORECARD.md
