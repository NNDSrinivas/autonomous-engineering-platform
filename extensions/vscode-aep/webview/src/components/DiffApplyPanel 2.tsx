import React, { useState } from 'react';

interface PatchFile {
  path: string;
  diff?: string;
  modified?: string;
  original?: string;
  hasConflicts?: boolean;
}

interface PatchBundle {
  files: PatchFile[];
  description?: string;
  statistics?: {
    lines?: {
      added: number;
      removed: number;
    };
    files_modified: number;
  };
  ready_to_apply: boolean;
  timestamp?: number;
}

interface DiffApplyPanelProps {
  patchBundle: PatchBundle;
  onApplyAll?: (patchBundle: PatchBundle) => void;
  onApplyFile?: (filePath: string, content: string) => void;
  onUndo?: () => void;
  className?: string;
}

const getFileBasename = (filePath: string): string => {
  return filePath.split('/').pop() || filePath;
};\n\nconst formatFileSize = (content?: string): string => {\n  if (!content) return '0 B';\n  const bytes = new Blob([content]).size;\n  if (bytes < 1024) return `${bytes} B`;\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n};\n\nexport const DiffApplyPanel: React.FC<DiffApplyPanelProps> = ({\n  patchBundle,\n  onApplyAll,\n  onApplyFile,\n  onUndo,\n  className = ''\n}) => {\n  const [isApplying, setIsApplying] = useState(false);\n  const [appliedFiles, setAppliedFiles] = useState<Set<string>>(new Set());\n\n  const vscodeApi = (window as any).acquireVsCodeApi?.();\n\n  const handleApplyAll = async () => {\n    if (isApplying) return;\n    \n    setIsApplying(true);\n    try {\n      if (onApplyAll) {\n        onApplyAll(patchBundle);\n      } else if (vscodeApi) {\n        vscodeApi.postMessage({\n          type: 'applyAll',\n          payload: patchBundle\n        });\n      }\n      \n      // Mark all files as applied\n      setAppliedFiles(new Set(patchBundle.files.map(f => f.path)));\n    } catch (error) {\n      console.error('Error applying all patches:', error);\n    } finally {\n      setIsApplying(false);\n    }\n  };\n\n  const handleApplyFile = async (file: PatchFile) => {\n    if (isApplying || appliedFiles.has(file.path)) return;\n    \n    setIsApplying(true);\n    try {\n      const content = file.modified || file.diff || '';\n      \n      if (onApplyFile) {\n        onApplyFile(file.path, content);\n      } else if (vscodeApi) {\n        vscodeApi.postMessage({\n          type: 'applyFile',\n          payload: {\n            filePath: file.path,\n            content\n          }\n        });\n      }\n      \n      // Mark file as applied\n      setAppliedFiles(prev => new Set([...prev, file.path]));\n    } catch (error) {\n      console.error(`Error applying patch to ${file.path}:`, error);\n    } finally {\n      setIsApplying(false);\n    }\n  };\n\n  const handleUndo = () => {\n    if (onUndo) {\n      onUndo();\n    } else if (vscodeApi) {\n      vscodeApi.postMessage({ type: 'undo' });\n    }\n    \n    // Clear applied files\n    setAppliedFiles(new Set());\n  };\n\n  const conflictFiles = patchBundle.files.filter(f => f.hasConflicts);\n  const totalFiles = patchBundle.files.length;\n  const appliedCount = appliedFiles.size;\n  const hasConflicts = conflictFiles.length > 0;\n\n  return (\n    <div className={`bg-white border border-gray-300 rounded-lg overflow-hidden ${className}`}>\n      {/* Header */}\n      <div className=\"bg-gray-50 border-b border-gray-200 p-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h3 className=\"text-lg font-semibold text-gray-800 flex items-center\">\n              üì¶ Patch Bundle\n              {patchBundle.ready_to_apply ? (\n                <span className=\"ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full\">\n                  Ready\n                </span>\n              ) : (\n                <span className=\"ml-2 text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full\">\n                  Review Required\n                </span>\n              )}\n            </h3>\n            \n            {patchBundle.description && (\n              <p className=\"text-sm text-gray-600 mt-1\">{patchBundle.description}</p>\n            )}\n          </div>\n          \n          <div className=\"text-right\">\n            <div className=\"text-sm text-gray-600\">\n              {appliedCount > 0 ? `${appliedCount}/${totalFiles}` : totalFiles} files\n            </div>\n            {patchBundle.statistics && (\n              <div className=\"text-xs text-gray-500 flex space-x-3 mt-1\">\n                {patchBundle.statistics.lines?.added && (\n                  <span className=\"text-green-600\">\n                    +{patchBundle.statistics.lines.added}\n                  </span>\n                )}\n                {patchBundle.statistics.lines?.removed && (\n                  <span className=\"text-red-600\">\n                    -{patchBundle.statistics.lines.removed}\n                  </span>\n                )}\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Conflicts Warning */}\n      {hasConflicts && (\n        <div className=\"bg-yellow-50 border-b border-yellow-200 p-3\">\n          <div className=\"flex items-center space-x-2\">\n            <span className=\"text-yellow-600\">‚ö†Ô∏è</span>\n            <div className=\"text-sm text-yellow-800\">\n              <strong>Merge conflicts detected</strong> in {conflictFiles.length} file{conflictFiles.length !== 1 ? 's' : ''}:\n              <div className=\"mt-1 font-mono text-xs\">\n                {conflictFiles.slice(0, 3).map(f => getFileBasename(f.path)).join(', ')}\n                {conflictFiles.length > 3 && ` and ${conflictFiles.length - 3} more`}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Action Buttons */}\n      <div className=\"p-4 space-y-3\">\n        <div className=\"flex flex-wrap gap-3\">\n          <button\n            onClick={handleApplyAll}\n            disabled={isApplying || !patchBundle.ready_to_apply}\n            className={`\n              px-4 py-2 rounded-lg font-medium text-sm flex items-center space-x-2\n              ${patchBundle.ready_to_apply && !isApplying\n                ? 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500'\n                : 'bg-gray-300 text-gray-500 cursor-not-allowed'\n              }\n              transition-colors\n            `}\n          >\n            {isApplying ? (\n              <>\n                <div className=\"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full\" />\n                <span>Applying...</span>\n              </>\n            ) : (\n              <>\n                <span>üöÄ</span>\n                <span>Apply All Changes</span>\n              </>\n            )}\n          </button>\n\n          <button\n            onClick={handleUndo}\n            disabled={isApplying || appliedFiles.size === 0}\n            className=\"\n              px-4 py-2 rounded-lg font-medium text-sm\n              bg-gray-600 text-white hover:bg-gray-700 disabled:bg-gray-300 disabled:text-gray-500\n              transition-colors flex items-center space-x-2\n            \"\n          >\n            <span>‚Ü©Ô∏è</span>\n            <span>Undo Last Changes</span>\n          </button>\n          \n          <button\n            onClick={() => {\n              if (vscodeApi) {\n                vscodeApi.postMessage({ type: 'showUndoHistory' });\n              }\n            }}\n            className=\"\n              px-3 py-2 rounded-lg font-medium text-sm\n              bg-gray-100 text-gray-700 hover:bg-gray-200\n              transition-colors flex items-center space-x-1\n            \"\n          >\n            <span>üìã</span>\n            <span>History</span>\n          </button>\n        </div>\n\n        {/* Progress bar */}\n        {appliedCount > 0 && (\n          <div className=\"mt-3\">\n            <div className=\"flex items-center justify-between text-xs text-gray-600 mb-1\">\n              <span>Progress</span>\n              <span>{appliedCount}/{totalFiles} files applied</span>\n            </div>\n            <div className=\"w-full bg-gray-200 rounded-full h-2\">\n              <div \n                className=\"bg-green-500 h-2 rounded-full transition-all duration-300\"\n                style={{ width: `${(appliedCount / totalFiles) * 100}%` }}\n              />\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* File List */}\n      <div className=\"border-t border-gray-200\">\n        <div className=\"max-h-64 overflow-y-auto\">\n          {patchBundle.files.map((file, index) => {\n            const isApplied = appliedFiles.has(file.path);\n            \n            return (\n              <div\n                key={file.path}\n                className={`\n                  flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0\n                  ${isApplied ? 'bg-green-50' : 'hover:bg-gray-50'}\n                  ${file.hasConflicts ? 'bg-yellow-50' : ''}\n                `}\n              >\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center space-x-2\">\n                    <span className=\"text-sm font-mono text-gray-800 truncate\">\n                      {getFileBasename(file.path)}\n                    </span>\n                    \n                    {isApplied && (\n                      <span className=\"text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full\">\n                        ‚úì Applied\n                      </span>\n                    )}\n                    \n                    {file.hasConflicts && (\n                      <span className=\"text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full\">\n                        ‚ö†Ô∏è Conflict\n                      </span>\n                    )}\n                  </div>\n                  \n                  <div className=\"text-xs text-gray-500 mt-1\">\n                    {file.path} ‚Ä¢ {formatFileSize(file.modified || file.diff)}\n                  </div>\n                </div>\n\n                <div className=\"flex items-center space-x-2\">\n                  <button\n                    onClick={() => {\n                      if (vscodeApi) {\n                        vscodeApi.postMessage({\n                          type: 'viewFile',\n                          payload: { filePath: file.path }\n                        });\n                      }\n                    }}\n                    className=\"\n                      px-2 py-1 text-xs\n                      bg-gray-100 text-gray-600 hover:bg-gray-200\n                      rounded transition-colors\n                    \"\n                  >\n                    üëÅÔ∏è View\n                  </button>\n                  \n                  <button\n                    onClick={() => handleApplyFile(file)}\n                    disabled={isApplying || isApplied || file.hasConflicts}\n                    className={`\n                      px-2 py-1 text-xs rounded transition-colors\n                      ${!isApplied && !file.hasConflicts && !isApplying\n                        ? 'bg-blue-100 text-blue-700 hover:bg-blue-200'\n                        : 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                      }\n                    `}\n                  >\n                    {isApplied ? '‚úì' : '‚ö°'} Apply\n                  </button>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      {/* Footer */}\n      <div className=\"bg-gray-50 border-t border-gray-200 px-4 py-3\">\n        <div className=\"text-xs text-gray-500\">\n          <p>\n            üí° <strong>Tip:</strong> Review changes before applying. \n            Undo is available for recent operations.\n            {hasConflicts && ' Resolve conflicts before applying patches.'}\n          </p>\n          \n          {patchBundle.timestamp && (\n            <p className=\"mt-1\">\n              Generated: {new Date(patchBundle.timestamp).toLocaleString()}\n            </p>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default DiffApplyPanel;