import * as vscode from 'vscode';

export function activate(ctx: vscode.ExtensionContext) {
  console.log('AEP: Extension activating...');
  vscode.window.showInformationMessage('AEP Extension is starting up!');

  const provider = new AepWelcomeProvider(ctx.extensionUri);

  const registration = vscode.window.registerWebviewViewProvider('aep.welcome', provider, {
    webviewOptions: { retainContextWhenHidden: true }
  });

  console.log('AEP: Registering webview provider for aep.welcome');
  ctx.subscriptions.push(registration);

  ctx.subscriptions.push(
    vscode.commands.registerCommand('aepPro.openHome', async () => {
      await vscode.commands.executeCommand('workbench.view.extension.aep');
      await vscode.commands.executeCommand('aep.welcome.focus');
    })
  );

  console.log('AEP: Extension activated successfully');
}

export function deactivate() { }

class AepWelcomeProvider implements vscode.WebviewViewProvider {
  private view?: vscode.WebviewView;
  constructor(private readonly extUri: vscode.Uri) { }

  resolveWebviewView(view: vscode.WebviewView) {
    console.log('AEP: resolveWebviewView called!');
    vscode.window.showInformationMessage('AEP View Provider: resolveWebviewView called!');
    this.view = view;
    const webview = view.webview;
    webview.options = {
      enableScripts: true,
      localResourceRoots: [this.extUri]
    };
    webview.html = this.html(webview);

    webview.onDidReceiveMessage((message) => {
      switch (message.type) {
        case 'ping':
          webview.postMessage({
            type: 'pong',
            when: new Date().toISOString(),
            text: message.t
          });
          break;
      }
    });
  }

  private html(webview: vscode.Webview) {
    const nonce = getNonce();
    return `<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Security-Policy"
  content="default-src 'none';
           img-src ${webview.cspSource} https:;
           style-src ${webview.cspSource} 'unsafe-inline';
           script-src 'nonce-${nonce}';">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AEP</title>
<style>
  body { color: var(--vscode-foreground); background: transparent; font-family: var(--vscode-font-family); margin: 0; }
  .wrap { padding: 16px; }
  .card { background: var(--vscode-editorWidget-background); border-radius: 10px; padding: 14px 16px; margin-bottom: 12px; border: 1px solid var(--vscode-widget-border); }
  h2 { margin: 0 0 8px 0; font-size: 13px; text-transform: uppercase; letter-spacing: .08em; opacity: .8; }
  .row { display:flex; gap:8px; margin-top:8px; }
  input { flex:1; padding:8px 10px; border-radius:8px; background: var(--vscode-input-background); color: var(--vscode-input-foreground); border:1px solid var(--vscode-input-border); font-size: 12px; }
  button { padding:8px 12px; border-radius:8px; border:1px solid var(--vscode-button-border, transparent); background: var(--vscode-button-background); color: var(--vscode-button-foreground); cursor:pointer; font-size: 11px; }
  .ghost { background: transparent; border-color: var(--vscode-input-border); }
  .muted { opacity:.7; font-size:12px; }
  .brand { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
  .dot { width: 12px; height: 12px; border-radius: 50%; background: linear-gradient(45deg, #0078d4, #8b5cf6); }
  .log { min-height: 60px; max-height: 120px; overflow-y: auto; padding: 8px; background: var(--vscode-editor-background); border-radius: 6px; margin-top: 8px; font-size: 12px; }
  .message { margin: 4px 0; padding: 4px 8px; border-radius: 4px; }
  .user { background: var(--vscode-button-secondaryBackground); }
  .aep { background: rgba(0, 120, 212, 0.1); border-left: 3px solid #0078d4; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <span class="dot"></span>
      <strong>AEP Professional</strong>
    </div>
    
    <div class="card">
      <h2>Chat</h2>
      <div class="row">
        <input id="msg" placeholder="Ask AEP anything about your codeâ€¦" />
        <button id="send">Send</button>
        <button id="clear" class="ghost">Clear</button>
      </div>
      <div id="log" class="log muted">No messages yet. Start a conversation.</div>
    </div>

    <div class="card">
      <h2>Quick Actions</h2>
      <div class="row">
        <button>Review Code</button>
        <button>Debug Issue</button>
      </div>
      <div class="row">
        <button>Generate Tests</button>
        <button>Explain Code</button>
      </div>
    </div>
  </div>
<script nonce="${nonce}">
  const vscode = acquireVsCodeApi();
  const msg = document.getElementById('msg');
  const log = document.getElementById('log');
  let hasMessages = false;

  document.getElementById('send').addEventListener('click', () => {
    const t = msg.value.trim();
    if (!t) return;
    
    if (!hasMessages) {
      log.textContent = '';
      hasMessages = true;
    }
    
    const userMsg = document.createElement('div');
    userMsg.className = 'message user';
    userMsg.textContent = 'You: ' + t;
    log.appendChild(userMsg);
    
    vscode.postMessage({ type: 'ping', t });
    msg.value = '';
    log.scrollTop = log.scrollHeight;
  });

  document.getElementById('clear').addEventListener('click', () => { 
    log.innerHTML = 'No messages yet. Start a conversation.';
    log.className = 'log muted';
    hasMessages = false;
    msg.value = ''; 
  });

  window.addEventListener('message', e => {
    if (e.data?.type === 'pong') {
      if (!hasMessages) {
        log.textContent = '';
        hasMessages = true;
      }
      log.className = 'log';
      
      const aepMsg = document.createElement('div');
      aepMsg.className = 'message aep';
      aepMsg.textContent = 'AEP: Got "' + e.data.text + '" at ' + e.data.when;
      log.appendChild(aepMsg);
      log.scrollTop = log.scrollHeight;
    }
  });

  msg.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('send').click();
  });
</script>
</body>
</html>`;
  }
}

function getNonce() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let s = '';
  for (let i = 0; i < 32; i++) s += chars[Math.floor(Math.random() * chars.length)];
  return s;
}
