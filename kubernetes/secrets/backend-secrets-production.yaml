# Kubernetes Secret for NAVI Backend - Production Environment
#
# ⚠️ CRITICAL: NEVER commit actual production credentials to source control!
#
# For production, use external secrets management:
#   - AWS Secrets Manager (recommended for AWS deployments)
#   - HashiCorp Vault
#   - GCP Secret Manager
#   - Azure Key Vault
#   - External Secrets Operator (https://external-secrets.io)
#
# Example with AWS Secrets Manager:
#   1. Store secrets in AWS:
#      aws secretsmanager create-secret --name navi/prod/audit-encryption-key --secret-string '<key>'
#      aws secretsmanager create-secret --name navi/prod/jwt-secret --secret-string '<key>'
#      aws secretsmanager create-secret --name navi/prod/openai-api-key --secret-string '<key>'
#
#   2. Use External Secrets Operator:
#      kubectl apply -f backend-external-secrets-production.yaml
#
# This file serves as a TEMPLATE for reference only.
---
apiVersion: v1
kind: Secret
metadata:
  name: navi-backend-secrets
  namespace: navi-production
  labels:
    app: navi
    component: backend
    environment: production
  annotations:
    # Mark as managed by external secrets (if using External Secrets Operator)
    # external-secrets.io/managed-by: "external-secrets-operator"
type: Opaque
stringData:
  # ================================
  # REQUIRED SECURITY KEYS
  # ================================

  # ⚠️ CRITICAL: These keys are MANDATORY for production
  # Backend will FAIL to start without them

  # Audit Encryption Key (MANDATORY for production)
  # Generate with: python -c 'import secrets; print(secrets.token_urlsafe(32))'
  # MUST be different from staging key
  # Store in AWS Secrets Manager: navi/prod/audit-encryption-key
  AUDIT_ENCRYPTION_KEY: "${PROD_AUDIT_ENCRYPTION_KEY}"

  # Audit encryption key ID for key rotation support
  # Update this when rotating keys: prod-v1 -> prod-v2
  AUDIT_ENCRYPTION_KEY_ID: "prod-v1"

  # JWT secret for token signing (MANDATORY)
  # Generate with: openssl rand -hex 32
  # Store in AWS Secrets Manager: navi/prod/jwt-secret
  JWT_SECRET: "${PROD_JWT_SECRET}"

  # Previous JWT secret for rotation (optional)
  # Allows zero-downtime key rotation
  # JWT_SECRET_PREVIOUS: "${PROD_JWT_SECRET_PREVIOUS}"

  # ================================
  # LLM PROVIDER API KEYS
  # ================================

  # OpenAI API key (required if using OpenAI/GPT models)
  # Store in AWS Secrets Manager: navi/prod/openai-api-key
  OPENAI_API_KEY: "${PROD_OPENAI_API_KEY}"

  # Anthropic API key (required if using Claude models)
  # Store in AWS Secrets Manager: navi/prod/anthropic-api-key
  ANTHROPIC_API_KEY: "${PROD_ANTHROPIC_API_KEY}"

  # ================================
  # INTEGRATION SECRETS
  # ================================

  # Jira integration (optional)
  AEP_JIRA_API_TOKEN: "${PROD_JIRA_API_TOKEN}"
  JIRA_WEBHOOK_SECRET: "${PROD_JIRA_WEBHOOK_SECRET}"

  # GitHub integration (optional)
  GITHUB_CLIENT_SECRET: "${PROD_GITHUB_CLIENT_SECRET}"
  GITHUB_WEBHOOK_SECRET: "${PROD_GITHUB_WEBHOOK_SECRET}"

  # Slack integration (optional)
  SLACK_CLIENT_SECRET: "${PROD_SLACK_CLIENT_SECRET}"
  SLACK_SIGNING_SECRET: "${PROD_SLACK_SIGNING_SECRET}"

  # Microsoft Teams (optional)
  TEAMS_CLIENT_SECRET: "${PROD_TEAMS_CLIENT_SECRET}"
  TEAMS_WEBHOOK_SECRET: "${PROD_TEAMS_WEBHOOK_SECRET}"

  # Zoom (optional)
  ZOOM_CLIENT_SECRET: "${PROD_ZOOM_CLIENT_SECRET}"
  ZOOM_WEBHOOK_SECRET: "${PROD_ZOOM_WEBHOOK_SECRET}"

  # Google Meet (optional)
  GOOGLE_CLIENT_SECRET: "${PROD_GOOGLE_CLIENT_SECRET}"
  MEET_WEBHOOK_SECRET: "${PROD_MEET_WEBHOOK_SECRET}"

  # ================================
  # AUTH0 CONFIGURATION
  # ================================

  # Auth0 client secret for OAuth device flow
  # Store in AWS Secrets Manager: navi/prod/auth0-client-secret
  AUTH0_CLIENT_SECRET: "${PROD_AUTH0_CLIENT_SECRET}"

  # ================================
  # REDIS CONFIGURATION
  # ================================

  # Redis URL (required for production multi-server deployments)
  # Use AWS ElastiCache, GCP Memorystore, or Azure Cache for Redis
  # Store in AWS Secrets Manager: navi/prod/redis-url
  REDIS_URL: "${PROD_REDIS_URL}"
---
# ConfigMap for non-sensitive backend configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: navi-backend-config
  namespace: navi-production
  labels:
    app: navi
    component: backend
    environment: production
data:
  # ================================
  # APPLICATION ENVIRONMENT
  # ================================

  # CRITICAL: Must be "production" to enforce audit encryption
  APP_ENV: "production"

  # Application name and slug
  APP_NAME: "NAVI"
  APP_SLUG: "navi"

  # Debug mode (ALWAYS disabled in production)
  DEBUG: "false"

  # ================================
  # AUDIT CONFIGURATION
  # ================================

  # Enable audit logging (MANDATORY for production)
  enable_audit_logging: "true"

  # Audit retention settings (compliance requirement)
  AUDIT_RETENTION_ENABLED: "true"
  AUDIT_RETENTION_DAYS: "365"  # 1 year for production

  # ================================
  # JWT CONFIGURATION
  # ================================

  # Enable JWT authentication (MANDATORY for production)
  JWT_ENABLED: "true"
  JWT_ALGORITHM: "HS256"

  # JWT audience and issuer (production values)
  JWT_AUDIENCE: "api.navi.example.com"
  JWT_ISSUER: "auth.navi.example.com"

  # ================================
  # CORS CONFIGURATION
  # ================================

  # Allowed CORS origins (production frontend only)
  CORS_ORIGINS: "https://navi.example.com"

  # VS Code webview support (for VS Code extension)
  ALLOW_VSCODE_WEBVIEW: "true"

  # VS Code auth enforcement (MANDATORY in production)
  VSCODE_AUTH_REQUIRED: "true"
  ALLOW_DEV_AUTH_BYPASS: "false"  # NEVER enable in production

  # ================================
  # RATE LIMITING
  # ================================

  # Enable rate limiting (MANDATORY for production)
  RATE_LIMITING_ENABLED: "true"
  RATE_LIMITING_ESTIMATED_ACTIVE_USERS: "50"  # Adjust based on org size

  # ================================
  # OBSERVABILITY
  # ================================

  # Log level (INFO for production, DEBUG only for troubleshooting)
  LOG_LEVEL: "INFO"

  # Prometheus metrics (required for production monitoring)
  PROMETHEUS_ENABLED: "true"

  # OpenTelemetry tracing (required for production observability)
  OTEL_ENABLED: "true"
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector.observability.svc.cluster.local:4318"

  # ================================
  # HEALTH & RESILIENCE
  # ================================

  # Health check timeouts (production values)
  HEALTH_CHECK_TIMEOUT_SEC: "5"
  HEALTH_CHECK_RETRY_COUNT: "3"

  # Circuit breaker settings (production tuning)
  CIRCUIT_FAIL_THRESHOLD: "5"
  CIRCUIT_WINDOW_SEC: "60"
  CIRCUIT_OPEN_SEC: "30"
  CIRCUIT_SUCCESS_TO_CLOSE: "2"

  # ================================
  # PRESENCE & CURSOR SYNC
  # ================================

  # Presence TTL and heartbeat
  PRESENCE_TTL_SEC: "60"
  HEARTBEAT_SEC: "20"
  PRESENCE_CLEANUP_INTERVAL_SEC: "60"

  # ================================
  # CACHING
  # ================================

  # Enable distributed caching (required for multi-server production)
  CACHE_ENABLED: "true"
  CACHE_DEFAULT_TTL_SEC: "600"
  CACHE_MAX_VALUE_BYTES: "262144"

  # ================================
  # API CONFIGURATION
  # ================================

  # API port (must match container port in deployment)
  API_PORT: "8787"
  API_HOST: "0.0.0.0"

  # Public base URL for OAuth redirects
  PUBLIC_BASE_URL: "https://api.navi.example.com"

  # ================================
  # LLM CONFIGURATION
  # ================================

  # Default model (production-grade model)
  OPENAI_MODEL: "gpt-4o"

  # ================================
  # INTEGRATION CONFIGURATION
  # ================================

  # Jira configuration
  AEP_JIRA_BASE_URL: "https://your-domain.atlassian.net"
  AEP_JIRA_EMAIL: "navi-prod@yourcompany.com"

  # Confluence configuration
  AEP_CONFLUENCE_BASE_URL: "https://your-domain.atlassian.net/wiki"
  AEP_CONFLUENCE_EMAIL: "navi-prod@yourcompany.com"

  # Auth0 configuration (public values)
  AUTH0_DOMAIN: "your-domain.auth0.com"
  AUTH0_CLIENT_ID: "your-auth0-client-id-prod"
  AUTH0_AUDIENCE: "https://api.navi.example.com"
  AUTH0_ALGORITHM: "RS256"

  # GitHub OAuth (public values)
  GITHUB_CLIENT_ID: "your-github-client-id-prod"

  # Slack OAuth (public values)
  SLACK_CLIENT_ID: "your-slack-client-id-prod"
