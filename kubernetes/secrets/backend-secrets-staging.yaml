# Kubernetes Secret for NAVI Backend - Staging Environment
#
# ⚠️ WARNING: This file contains placeholders. Do NOT commit actual credentials.
#
# To create the secret:
#   1. Generate encryption key:
#      python -c 'import secrets; print(secrets.token_urlsafe(32))'
#
#   2. Create secret with actual values:
#      kubectl create secret generic navi-backend-secrets \
#        --from-literal=AUDIT_ENCRYPTION_KEY='<generated-key>' \
#        --from-literal=JWT_SECRET='<jwt-secret>' \
#        --from-literal=OPENAI_API_KEY='<openai-key>' \
#        --namespace navi-staging
#
# Or apply this file after replacing placeholders:
#   kubectl apply -f backend-secrets-staging.yaml
---
apiVersion: v1
kind: Secret
metadata:
  name: navi-backend-secrets
  namespace: navi-staging
  labels:
    app: navi
    component: backend
    environment: staging
type: Opaque
stringData:
  # ================================
  # REQUIRED SECURITY KEYS
  # ================================

  # Audit Encryption Key (MANDATORY for staging/production)
  # ⚠️ CRITICAL: Backend will FAIL to start without this key in staging/production
  # Generate with: python -c 'import secrets; print(secrets.token_urlsafe(32))'
  AUDIT_ENCRYPTION_KEY: "${STAGING_AUDIT_ENCRYPTION_KEY}"

  # Audit encryption key ID for key rotation support
  AUDIT_ENCRYPTION_KEY_ID: "staging-v1"

  # JWT secret for token signing
  # Generate with: openssl rand -hex 32
  JWT_SECRET: "${STAGING_JWT_SECRET}"

  # Previous JWT secret for rotation (optional)
  # JWT_SECRET_PREVIOUS: "${STAGING_JWT_SECRET_PREVIOUS}"

  # ================================
  # LLM PROVIDER API KEYS
  # ================================

  # OpenAI API key (required if using OpenAI/GPT models)
  OPENAI_API_KEY: "${STAGING_OPENAI_API_KEY}"

  # Anthropic API key (required if using Claude models)
  ANTHROPIC_API_KEY: "${STAGING_ANTHROPIC_API_KEY}"

  # ================================
  # INTEGRATION SECRETS
  # ================================

  # Jira integration (optional)
  AEP_JIRA_API_TOKEN: "${STAGING_JIRA_API_TOKEN}"
  JIRA_WEBHOOK_SECRET: "${STAGING_JIRA_WEBHOOK_SECRET}"

  # GitHub integration (optional)
  GITHUB_CLIENT_SECRET: "${STAGING_GITHUB_CLIENT_SECRET}"
  GITHUB_WEBHOOK_SECRET: "${STAGING_GITHUB_WEBHOOK_SECRET}"

  # Slack integration (optional)
  SLACK_CLIENT_SECRET: "${STAGING_SLACK_CLIENT_SECRET}"
  SLACK_SIGNING_SECRET: "${STAGING_SLACK_SIGNING_SECRET}"

  # Microsoft Teams (optional)
  TEAMS_CLIENT_SECRET: "${STAGING_TEAMS_CLIENT_SECRET}"
  TEAMS_WEBHOOK_SECRET: "${STAGING_TEAMS_WEBHOOK_SECRET}"

  # Zoom (optional)
  ZOOM_CLIENT_SECRET: "${STAGING_ZOOM_CLIENT_SECRET}"
  ZOOM_WEBHOOK_SECRET: "${STAGING_ZOOM_WEBHOOK_SECRET}"

  # Google Meet (optional)
  GOOGLE_CLIENT_SECRET: "${STAGING_GOOGLE_CLIENT_SECRET}"
  MEET_WEBHOOK_SECRET: "${STAGING_MEET_WEBHOOK_SECRET}"

  # ================================
  # AUTH0 CONFIGURATION
  # ================================

  # Auth0 client secret for OAuth device flow
  AUTH0_CLIENT_SECRET: "${STAGING_AUTH0_CLIENT_SECRET}"

  # ================================
  # REDIS CONFIGURATION
  # ================================

  # Redis URL (optional - uses in-memory if not set)
  # For staging, we recommend using a managed Redis instance
  REDIS_URL: "${STAGING_REDIS_URL}"
---
# ConfigMap for non-sensitive backend configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: navi-backend-config
  namespace: navi-staging
  labels:
    app: navi
    component: backend
    environment: staging
data:
  # ================================
  # APPLICATION ENVIRONMENT
  # ================================

  # CRITICAL: Must be "staging" to enforce audit encryption
  APP_ENV: "staging"

  # Application name and slug
  APP_NAME: "NAVI"
  APP_SLUG: "navi"

  # Debug mode (disabled in staging)
  DEBUG: "false"

  # ================================
  # AUDIT CONFIGURATION
  # ================================

  # Enable audit logging (required for production/staging)
  enable_audit_logging: "true"

  # Audit retention settings
  AUDIT_RETENTION_ENABLED: "true"
  AUDIT_RETENTION_DAYS: "90"

  # ================================
  # JWT CONFIGURATION
  # ================================

  # Enable JWT authentication
  JWT_ENABLED: "true"
  JWT_ALGORITHM: "HS256"

  # Optional JWT audience/issuer
  # JWT_AUDIENCE: "api.navi-staging.example.com"
  # JWT_ISSUER: "auth.navi-staging.example.com"

  # ================================
  # CORS CONFIGURATION
  # ================================

  # Allowed CORS origins (comma-separated)
  CORS_ORIGINS: "https://staging.navi.example.com"

  # VS Code webview support
  ALLOW_VSCODE_WEBVIEW: "true"

  # VS Code auth enforcement
  VSCODE_AUTH_REQUIRED: "true"
  ALLOW_DEV_AUTH_BYPASS: "false"

  # ================================
  # RATE LIMITING
  # ================================

  # Enable rate limiting
  RATE_LIMITING_ENABLED: "true"
  RATE_LIMITING_ESTIMATED_ACTIVE_USERS: "10"

  # ================================
  # OBSERVABILITY
  # ================================

  # Log level
  LOG_LEVEL: "INFO"

  # Prometheus metrics
  PROMETHEUS_ENABLED: "true"

  # OpenTelemetry tracing
  OTEL_ENABLED: "true"
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"

  # ================================
  # HEALTH & RESILIENCE
  # ================================

  # Health check timeouts
  HEALTH_CHECK_TIMEOUT_SEC: "5"
  HEALTH_CHECK_RETRY_COUNT: "3"

  # Circuit breaker settings
  CIRCUIT_FAIL_THRESHOLD: "5"
  CIRCUIT_WINDOW_SEC: "60"
  CIRCUIT_OPEN_SEC: "30"
  CIRCUIT_SUCCESS_TO_CLOSE: "2"

  # ================================
  # PRESENCE & CURSOR SYNC
  # ================================

  # Presence TTL and heartbeat
  PRESENCE_TTL_SEC: "60"
  HEARTBEAT_SEC: "20"
  PRESENCE_CLEANUP_INTERVAL_SEC: "60"

  # ================================
  # CACHING
  # ================================

  # Enable distributed caching
  CACHE_ENABLED: "true"
  CACHE_DEFAULT_TTL_SEC: "600"
  CACHE_MAX_VALUE_BYTES: "262144"

  # ================================
  # API CONFIGURATION
  # ================================

  # API port (must match container port in deployment)
  API_PORT: "8787"
  API_HOST: "0.0.0.0"

  # Public base URL for OAuth redirects
  PUBLIC_BASE_URL: "https://api.navi-staging.example.com"

  # ================================
  # LLM CONFIGURATION
  # ================================

  # Default model (can be overridden per request)
  OPENAI_MODEL: "gpt-4o"

  # ================================
  # INTEGRATION CONFIGURATION
  # ================================

  # Jira configuration
  AEP_JIRA_BASE_URL: "https://your-domain.atlassian.net"
  AEP_JIRA_EMAIL: "navi-staging@yourcompany.com"

  # Confluence configuration
  AEP_CONFLUENCE_BASE_URL: "https://your-domain.atlassian.net/wiki"
  AEP_CONFLUENCE_EMAIL: "navi-staging@yourcompany.com"

  # Auth0 configuration (public values)
  AUTH0_DOMAIN: "your-domain-staging.auth0.com"
  AUTH0_CLIENT_ID: "your-auth0-client-id-staging"
  AUTH0_AUDIENCE: "https://api.navi-staging.example.com"
  AUTH0_ALGORITHM: "RS256"

  # GitHub OAuth (public values)
  GITHUB_CLIENT_ID: "your-github-client-id-staging"

  # Slack OAuth (public values)
  SLACK_CLIENT_ID: "your-slack-client-id-staging"
