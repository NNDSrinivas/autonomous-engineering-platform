# Kubernetes Secret for Production Database Credentials
#
# CRITICAL: This file contains placeholders. NEVER commit actual credentials.
#
# Best practice for production: Use external secrets management
#   - AWS Secrets Manager: https://github.com/external-secrets/external-secrets
#   - HashiCorp Vault: https://www.vaultproject.io/docs/platform/k8s
#   - Google Secret Manager: https://cloud.google.com/secret-manager
#
# To create the secret manually:
#   kubectl create secret generic navi-database-production \
#     --from-literal=DATABASE_URL='postgresql+psycopg2://navi_prod:${PROD_DB_PASSWORD}@prod-db-host:5432/navi_prod' \
#     --namespace navi-production
---
apiVersion: v1
kind: Secret
metadata:
  name: navi-database-production
  namespace: navi-production
  labels:
    app: navi
    environment: production
    criticality: high
  annotations:
    # Track secret creation/rotation
    created-by: "DevOps Team"
    last-rotated: "YYYY-MM-DD"
type: Opaque
stringData:
  # PostgreSQL connection string
  # Format: postgresql+psycopg2://user:password@host:port/database
  #
  # PRODUCTION CHECKLIST:
  # - Use strong password (min 32 chars, random)
  # - Enable SSL/TLS (sslmode=require)
  # - Use read replica for analytics queries
  # - Configure connection pooling (PgBouncer recommended)
  DATABASE_URL: "postgresql+psycopg2://navi_prod:${PROD_DB_PASSWORD}@postgres-production.navi.svc.cluster.local:5432/navi_prod?sslmode=require"

  # Read-only replica for analytics/reporting (reduces load on primary)
  DATABASE_URL_READONLY: "postgresql+psycopg2://navi_prod_ro:${READONLY_DB_PASSWORD}@postgres-production-ro.navi.svc.cluster.local:5432/navi_prod?sslmode=require"

  # Individual components
  DB_HOST: "postgres-production.navi.svc.cluster.local"
  DB_PORT: "5432"
  DB_NAME: "navi_prod"
  DB_USER: "navi_prod"
  DB_PASSWORD: "${PROD_DB_PASSWORD}"

  # SSL/TLS configuration
  DB_SSLMODE: "require"
  DB_SSLCERT_PATH: "/var/run/secrets/db-certs/client-cert.pem"
  DB_SSLKEY_PATH: "/var/run/secrets/db-certs/client-key.pem"
  DB_SSLROOTCERT_PATH: "/var/run/secrets/db-certs/ca-cert.pem"
---
# ConfigMap for non-sensitive database configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: navi-database-config-production
  namespace: navi-production
  labels:
    app: navi
    environment: production
data:
  # Connection pool settings (tuned for production load)
  DB_POOL_SIZE: "50"
  DB_MAX_OVERFLOW: "100"
  DB_POOL_TIMEOUT: "30"
  DB_POOL_RECYCLE: "1800"  # 30 minutes
  DB_POOL_PRE_PING: "true"  # Verify connections before use

  # Alembic migration settings
  ALEMBIC_AUTO_UPGRADE: "false"  # Manual migrations in production!

  # Query logging
  DB_ECHO: "false"

  # Performance monitoring
  DB_ENABLE_STATEMENT_TIMEOUT: "true"
  DB_STATEMENT_TIMEOUT_MS: "30000"  # 30 seconds max query time

  # High availability
  DB_RETRY_ATTEMPTS: "3"
  DB_RETRY_DELAY_MS: "1000"
